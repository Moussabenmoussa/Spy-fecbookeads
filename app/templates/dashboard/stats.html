<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | TRAFICOON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- مكتبة الرسوم البيانية الاحترافية -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>body{font-family:'Inter',sans-serif;background-color:#f8fafc}</style>
</head>
<body class="text-slate-800 pb-20">

    <!-- Header -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="p-2 hover:bg-slate-100 rounded-full transition">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </a>
                <div>
                    <h1 class="font-bold text-lg text-slate-900">{{ link.title }}</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <a href="/{{ link.category }}/{{ link.slug }}" target="_blank" class="text-xs text-blue-600 hover:underline font-mono">/{{ link.slug }}</a>
                    </div>
                </div>
            </div>
            <button onclick="window.location.reload()" class="text-xs font-bold bg-slate-50 text-slate-600 px-3 py-1.5 rounded border hover:bg-white transition">Refresh Data ↻</button>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">

        <!-- 1. نظرة عامة (KPI Cards) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Traffic Quality Card -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg class="w-24 h-24 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                </div>
                <p class="text-sm font-bold text-slate-400 uppercase tracking-widest">Verified Humans</p>
                <h2 class="text-4xl font-black text-slate-900 mt-2">{{ link.clicks }}</h2>
                <div class="mt-4 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Safe Traffic</span>
                    <span class="text-xs text-slate-400">Ready for AdSense</span>
                </div>
            </div>

            <!-- Security Shield Card -->
            <div class="bg-white p-6 rounded-2xl border border-red-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg class="w-24 h-24 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                </div>
                <p class="text-sm font-bold text-red-400 uppercase tracking-widest">Threats Blocked</p>
                <h2 class="text-4xl font-black text-red-600 mt-2">{{ blocked_count }}</h2>
                <div class="mt-4 flex items-center gap-2">
                    <span class="bg-red-50 text-red-600 px-2 py-1 rounded text-xs font-bold">Bots Filtered</span>
                    <span class="text-xs text-slate-400">Saved bandwidth</span>
                </div>
            </div>
        </div>

        <!-- 2. الرسوم البيانية (Charts) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- مخطط أنظمة التشغيل (OS) -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-6">Device & OS Breakdown</h3>
                <div id="chart-os"></div>
                {% if not os_data %}
                <div class="text-center py-10 text-slate-400 text-sm">No visitor data yet.</div>
                {% endif %}
            </div>

            <!-- مخطط البوتات المحظورة -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-6">Security Logs (Blocked Bots)</h3>
                <div id="chart-bots"></div>
                {% if not bots_data %}
                <div class="text-center py-10 text-slate-400 text-sm">No threats detected yet.</div>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- كود الجافاسكريبت لرسم البيانات -->
    <script>
        // 1. تجهيز بيانات أنظمة التشغيل
        var osLabels = [];
        var osSeries = [];
        
        {% for item in os_data %}
            osLabels.push("{{ item._id }}");
            osSeries.push({{ item.count }});
        {% endfor %}

        if (osSeries.length > 0) {
            var optionsOS = {
                series: osSeries,
                chart: { type: 'donut', height: 300 },
                labels: osLabels,
                colors: ['#2563eb', '#10b981', '#f59e0b', '#6366f1'],
                dataLabels: { enabled: false },
                legend: { position: 'bottom' }
            };
            var chartOS = new ApexCharts(document.querySelector("#chart-os"), optionsOS);
            chartOS.render();
        }

        // 2. تجهيز بيانات البوتات
        var botLabels = [];
        var botSeries = [];

        {% for item in bots_data %}
            botLabels.push("{{ item._id }}");
            botSeries.push({{ item.count }});
        {% endfor %}

        if (botSeries.length > 0) {
            var optionsBots = {
                series: [{ name: 'Blocked', data: botSeries }],
                chart: { type: 'bar', height: 300, toolbar: {show: false} },
                xaxis: { categories: botLabels },
                colors: ['#ef4444'],
                plotOptions: { bar: { borderRadius: 4, horizontal: true } },
                dataLabels: { enabled: true }
            };
            var chartBots = new ApexCharts(document.querySelector("#chart-bots"), optionsBots);
            chartBots.render();
        }
    </script>

</body>
</html>
